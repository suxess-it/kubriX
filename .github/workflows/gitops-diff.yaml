on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

name: Diff GitOps

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
         path: pr
      - name: Checkout Target of PR
        uses: actions/checkout@v4
        with:
          path: target
          ref: ${{ github.event.pull_request.base.ref }}

      - name: diff charts
        shell: bash
        run: |
          bash pr/.github/create-pr-comment-file.sh

  create-pr-comment:
      needs: diff
      runs-on: ubuntu-latest
      strategy:
        matrix: ${{fromJSON(needs.diff.outputs.matrix)}}
      steps:
      - uses: thollander/actions-comment-pull-request@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          filePath: ${{matrix.comment-files}}

      - name: PR comment default values with file
        uses: thollander/actions-comment-pull-request@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          filePath: comment-files/comment-default-values-result.txt
