on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

name: Diff GitOps

jobs:
  diff:
    runs-on: ubuntu-lates
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
         path: pr
      - name: Checkout Target of PR
        uses: actions/checkout@v4
        with:
          path: target
          ref: ${{ github.event.pull_request.base.ref }}

      - name: diff charts
        shell: bash
        run: |
          pwd
          ls
          for env in pr target; do
            cd ${env}/platform-apps/charts
            pwd
            for chart in $( ls ); do
              echo ${chart}
              helm dependency update ${chart}
              helm template ${chart} -f ${chart}/values-k3d.yaml > ../../../${chart}_k3d.out
              helm template ${chart} -f ${chart}/values-metalstack.yaml > ../../../${chart}_metalstack.out
            done
            cd -
          done
        
