on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

name: Diff GitOps

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
         path: pr
      - name: Checkout Target of PR
        uses: actions/checkout@v4
        with:
          path: target
          ref: ${{ github.event.pull_request.base.ref }}

      - name: diff charts
        shell: bash
        run: |
          pwd
          ls
          for env in pr target; do
            cd ${env}/platform-apps/charts
            pwd
            for chart in $( ls ); do
              echo ${chart}
              helm dependency update ${chart}
              for value in $( find ${chart} -type f -name "values*" ); do
                helm template ${chart} -f ${chart}/${value} > ../../../${env}_${chart}_${value}
              done
            done
            cd -
          done
        
