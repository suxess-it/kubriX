# This Job runs in the same sync-wave as the Keycloak CR (wave 0).
# ArgoCD waits for ALL resources in a wave to be healthy before advancing.
# A Job is healthy only when it completes successfully, so this acts as an
# explicit gate: wave 1 (Realm creation) cannot start until Keycloak is
# actually serving its /health/ready endpoint â€” regardless of whether ArgoCD
# has a built-in health check configured for the Keycloak CRD.
apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-readiness-check
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  activeDeadlineSeconds: 360
  backoffLimit: 0          # retries are handled inside the container
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: curl
        image: curlimages/curl:latest
        env:
          - name: URL
            value: "https://keycloak{{ .Values.kubrix.keycloak.domainName }}/health/ready"
          - name: TIMEOUT_SECONDS
            value: "300"
          - name: SLEEP_SECONDS
            value: "5"
{{- if (contains "nip.io" .Values.kubrix.keycloak.domainName) }}
          - name: CURL_CA_BUNDLE
            value: "/etc/ssl/custom/ca.crt"
        volumeMounts:
          - name: ca-cert
            mountPath: /etc/ssl/custom
            readOnly: true
{{- end }}
        command:
          - sh
          - -c
          - |
            start=$(date +%s)
            end=$((start + TIMEOUT_SECONDS))
            echo "Probing $URL with custom CA ($CURL_CA_BUNDLE) for up to ${TIMEOUT_SECONDS}s ..."
            while [ "$(date +%s)" -lt "$end" ]; do
              if curl -fsS "$URL" > /dev/null; then
                echo "Success: $URL is reachable."
                exit 0
              fi
              echo "Not ready yet. Retrying in ${SLEEP_SECONDS}s ..."
              sleep "$SLEEP_SECONDS"
            done
            echo "Timed out after ${TIMEOUT_SECONDS}s waiting for $URL"
            exit 1
{{- if (contains "nip.io" .Values.kubrix.keycloak.domainName) }}
      volumes:
        - name: ca-cert
          secret:
            secretName: ca-cert
            items:
              - key: ca.crt
                path: ca.crt
                mode: 0444
{{- end }}
