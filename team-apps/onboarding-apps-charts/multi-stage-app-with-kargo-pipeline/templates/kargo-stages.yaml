{{- range .Values.stages }}
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: {{ .name }}
  namespace: {{ tpl $.Values.kargoProject $ }}
spec:
{{- with .requestedFreight }}
  requestedFreight:
  {{- tpl ( toYaml .) $ | nindent 4 }}
{{- end }}
  promotionTemplate:
    spec:
      vars:
      - name: gitRepo
        value: {{ $.Values.repoUrl }}
      steps:
      - uses: git-clone
        config:
          repoURL: ${{`{{ vars.gitRepo }}`}}
          checkout:
          - commit: ${{`{{ commitFrom(vars.gitRepo).ID }}`}}
            path: ./src
          - branch: stages/${{`{{ ctx.stage }}`}}
            create: true
            path: ./out
      - uses: git-clear
        config:
          path: ./out
      - uses: copy
        config:
          inPath: ./src
          outPath: ./out
      - uses: git-commit
        as: commit
        config:
          path: ./out
          message: "Kargo applied some changes"
      {{- if .openPr }}
      - uses: git-push
        as: push
        config:
          generateTargetBranch: true
          path: ./out
      - uses: git-open-pr
        as: open-pr
        config:
          createTargetBranch: true
          repoURL: ${{`{{ vars.gitRepo }}`}}
          sourceBranch: ${{`{{ outputs.push.branch }}`}}
          targetBranch: stages/${{`{{ ctx.stage }}`}}
          title: push changes to ${{`{{ ctx.stage }}`}}
      - uses: git-wait-for-pr
        as: wait-for-pr
        config:
          prNumber: ${{`{{ outputs['open-pr'].pr.id }}`}}
          repoURL: ${{`{{ vars.gitRepo }}`}}
        retry:
          timeout: 48h0m0s
          
      {{- else }}
      - uses: git-push
        config:
          path: ./out
          targetBranch: stages/${{`{{ ctx.stage }}`}}
      {{- end }}
      - uses: argocd-update
        config:
          apps:
          - name: {{ $.Values.appName }}-${{`{{ ctx.stage }}`}}
            namespace: {{ $.Release.Namespace }}
            sources:
            - repoURL: ${{`{{ vars.gitRepo }}`}}
              {{- if .openPr }}
              desiredRevision: ${{`{{ outputs['wait-for-pr'].commit }}`}}
              {{- else }}
              desiredRevision: ${{`{{ outputs.commit.commit }}`}}
              {{- end }}
---
{{- end }}
